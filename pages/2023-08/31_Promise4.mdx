# éåŒæœŸå‡¦ç†â‘¥

### è¤‡æ•°ã®Promiseã‚’èµ°ã‚‰ã›ã‚‹
- Promiseã‚’åŒæœŸçš„ã«ï¼’ã¤ã«èµ°ã‚‰ã›ã‚‹ã¨é †ç•ªãŒè¤‡é›‘ã«ãªã‚‹ãŸã‚æ³¨æ„
```js
// doubleThenCallback.js
console.log("ğŸ¦– [1] MAINLINE: Sync");

const returnPromise = (resolvedValue, order) => {
  return new Promise((resolve) => {
    console.log(`ğŸ‘» [${order}] Sync`);
    resolve(resolvedValue);
  });
};

returnPromise("1st Promise", "2").then((value) => {
  console.log("ğŸ‘¦ [5] Async");
  console.log("ğŸ‘¦ Resolved value:", value);
});
returnPromise("2nd Promise", "3").then((value) => {
  console.log("ğŸ‘¦ [6] Async");
  console.log("ğŸ‘¦ Resolved value:", value);
});

console.log("ğŸ¦– [4] MAINLINE: Sync");
```


### then ãƒ¡ã‚½ãƒƒãƒ‰ã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã§ Promise ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’è¿”ã™
thenãƒ¡ã‚½ãƒƒãƒ‰ã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯é–¢æ•°ã§Promiseã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’returnã™ã‚‹ã¨ã©ã†ãªã‚‹ã®ã‹ï¼Ÿ
**ã€Œæ¸¡ã•ã‚ŒãŸ Promise ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã® resolve ã«ä½¿ã‚ã‚ŒãŸå€¤ãŒæ¬¡ã® then() ãƒ¡ã‚½ãƒƒãƒ‰ã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯é–¢æ•°ã®å¼•æ•°ã¨ã—ã¦æ¸¡ã•ã‚Œã‚‹ã€**

```js
/* <n> ã¯ç™ºç”Ÿã—ã¦ã„ã‚‹ãƒã‚¤ã‚¯ãƒ­ã‚¿ã‚¹ã‚¯ã®è¿½è·¡é †ç•ª */
Promise.resolve(42)
  .then(x => { // <1> ã“ã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯é–¢æ•°ãŒï¼‘ã¤ç›®ã®ãƒã‚¤ã‚¯ãƒ­ã‚¿ã‚¹ã‚¯
    return Promise.resolve(x + 1);
    // <2> Promise.resolve(43).then(resolve, reject) ã®å‘¼ã³å‡ºã—
    // <3> resolve ã®å®Ÿè¡Œ
  })
  .then(x => { // <4> ã“ã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯é–¢æ•°ãŒï¼”ã¤ç›®ã®ãƒã‚¤ã‚¯ãƒ­ã‚¿ã‚¹ã‚¯
    console.log(x);
  });
```
ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‹ã‚‰ Promise ãŒè¿”ã•ã‚Œã‚‹å ´åˆã«ç™ºç”Ÿã™ã‚‹ãƒã‚¤ã‚¯ãƒ­ã‚¿ã‚¹ã‚¯ã‚’è¿½è·¡ã™ã‚‹ã¨ã€ä»¥ä¸‹ã®ã‚ˆã†ã«è¿½åŠ ã§ãƒã‚¤ã‚¯ãƒ­ã‚¿ã‚¹ã‚¯ãŒï¼’ã¤ç™ºç”Ÿã—ã¦ã„ã¾ã™ã€‚


### Promise Chainã®ãƒã‚¹ãƒˆ
- ã“ã‚Œã¾ã§ã¯Promiseã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’è¿”ã—ã¦ã„ãŸãŒã€Promise.then(callbackFn)ã‚’è¿”ã™ã¨PromiseãŒãƒã‚¹ãƒˆã•ã‚ŒãŸçŠ¶æ…‹ã«ãªã‚‹ã€‚ã“ã®ã¨ãã©ã†ãªã‚‹ã‹ï¼Ÿ
```js
// promiseNest.js
console.log('ğŸ¦– [1] Sync');

const returnPromise = (resolvedValue, order) => {
  return new Promise((resolve) => {
    console.log(`ğŸ‘» [${order}] (a)sync`);
    resolve(resolvedValue);
  });
};

returnPromise('1st Promise', '2')
  .then((value) => {
    console.log('ğŸ‘¦ [5] Async');
    console.log('ğŸ‘¦ Resolved value: ', value);

    return returnPromise('2nd Promise', '6')
      .then((value) => {
        console.log('ğŸ‘¦ [9] Async');
        console.log('ğŸ‘¦ Resolved value: ', value);
        return 'from [9] callback';
      });
  })
  .then((value) => {
    console.log('ğŸ‘¦ [11] Async');
    console.log('ğŸ‘¦ Resolved value: ', value);
  });

returnPromise('3rd Promise', '3')
  .then((value) => {
    console.log('ğŸ‘¦ [7] Async');
    console.log('ğŸ‘¦ Resolved value: ', value);

    return returnPromise('4th Promise', '8')
      .then((value) => {
        console.log('ğŸ‘¦ [10] Async');
        console.log('ğŸ‘¦ Resolved value: ', value);
        return 'from [10] callback';
      });
  })
  .then((value) => {
    console.log('ğŸ‘¦ [12] Async');
    console.log('ğŸ‘¦ Resolved value: ', value);
  });

console.log('ğŸ¦– [4] Sync');
```
å‡ºåŠ›é †ã¯ã€Œè¤‡æ•°ã®Promiseã‚’èµ°ã‚‰ã›ã‚‹ã€ã¨ã€ŒPromiseã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’thenå†…ã§returnã™ã‚‹ã€ã®çµ„ã¿åˆã‚ã›é€šã‚Šã§ã™ãŒã€åœ§å€’çš„ã«è¦‹ã«ãããªã‚‹ãŸã‚ãƒã‚¹ãƒˆã¯éæ¨å¥¨ã€‚

çµå±€ã€è¦ªã®Promise chainã®é †ç•ªã¯å®ˆã‚‰ã‚Œã‚‹ãŸã‚ã€å­ã®Promise chainã‚’ã‚„ã‚ã¦è¦ªã®Promise chainã ã‘ã«ã™ã‚‹ã€‚
ãƒã‚¤ã‚¯ãƒ­ã‚¿ã‚¹ã‚¯ã®é †åºã¯å…¥ã‚Œæ›¿ã‚ã‚‹ãŒã€ã‚³ãƒ³ã‚½ãƒ¼ãƒ«å‡ºåŠ›é †ã¯åŒã˜ã«ãªã‚‹
```js
// promiseNestShallow.js
console.log('ğŸ¦– [1] Sync');

const returnPromise = (resolvedValue, order) => {
  return new Promise((resolve) => {
    console.log(`ğŸ‘» [${order}] (a)sync`);
    resolve(resolvedValue);
  });
};

returnPromise('1st Promise', '2')
  .then((value) => {
    console.log('ğŸ‘¦ [5] Async');
    console.log('ğŸ‘¦ Resolved value: ', value);
    return returnPromise('2nd Promise', '6');
  })
  .then((value) => {
    console.log('ğŸ‘¦ [9] Async');
    console.log('ğŸ‘¦ Resolved value: ', value);
    return 'from [9] callback';
  })
  .then((value) => {
    console.log('ğŸ‘¦ [11] Async');
    console.log('ğŸ‘¦ Resolved value: ', value);
  });

returnPromise('3rd Promise', '3')
  .then((value) => {
    console.log('ğŸ‘¦ [7] Async');
    console.log('ğŸ‘¦ Resolved value: ', value);
    return returnPromise('4th Promise', '8');
  })
  .then((value) => {
    console.log('ğŸ‘¦ [10] Async');
    console.log('ğŸ‘¦ Resolved value: ', value);
    return 'from [10] callback';
  })
  .then((value) => {
    console.log('ğŸ‘¦ [12] Async');
    console.log('ğŸ‘¦ Resolved value: ', value);
  });

console.log('ğŸ¦– [4] Sync');
```

### thenãƒ¡ã‚½ãƒƒãƒ‰ã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯é–¢æ•°ã§ã®returnãƒ‘ã‚¿ãƒ¼ãƒ³
ä»Šã¾ã§then() ãƒ¡ã‚½ãƒƒãƒ‰ã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯é–¢æ•°å†…ã«ã¦è¿”ã™ã‚‚ã®ã¨ã—ã¦ã¯æ¬¡ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã§ã—ãŸã€‚

- (1) æ–‡å­—åˆ—ã‚„æ•°å€¤ãªã©ã®é€šå¸¸ã®å€¤ã‚’ return ã™ã‚‹
  - ç›´ã¡ã«æ¬¡ã® then() ãƒ¡ã‚½ãƒƒãƒ‰ã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ãŒãƒã‚¤ã‚¯ãƒ­ã‚¿ã‚¹ã‚¯ã‚­ãƒ¥ãƒ¼ã¸ã¨è¿½åŠ ã•ã‚Œã¦ã€ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯é–¢æ•°ã®å¼•æ•°ã«ã¯ return ã—ãŸå€¤ãŒæ¸¡ã•ã‚Œã‚‹
- (2) Promise ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ return ã™ã‚‹
  - å¾…æ©ŸçŠ¶æ…‹ãªã‚‰ãã‚ŒãŒè§£æ±ºã—ã¦ã‹ã‚‰æ¬¡ã® then() ãƒ¡ã‚½ãƒƒãƒ‰ã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ãŒãƒã‚¤ã‚¯ãƒ­ã‚¿ã‚¹ã‚¯ã‚­ãƒ¥ãƒ¼ã¸ã¨è¿½åŠ ã•ã‚Œã€resolve ã—ãŸå€¤ãŒã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯é–¢æ•°ã®å¼•æ•°ã«æ¸¡ã•ã‚Œã‚‹
  - å±¥è¡ŒçŠ¶æ…‹ãªã‚‰ç›´ã¡ã«æ¬¡ã® then() ãƒ¡ã‚½ãƒƒãƒ‰ã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ãŒãƒã‚¤ã‚¯ãƒ­ã‚¿ã‚¹ã‚¯ã‚­ãƒ¥ãƒ¼ã¸ã¨è¿½åŠ ã•ã‚Œã€resolve ã—ãŸå€¤ãŒã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯é–¢æ•°ã®å¼•æ•°ã«æ¸¡ã•ã‚Œã‚‹
- (3) ä½•ã‚‚ return ã—ãªã„
  - ç›´ã¡ã«æ¬¡ã® then() ãƒ¡ã‚½ãƒƒãƒ‰ã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ãŒãƒã‚¤ã‚¯ãƒ­ã‚¿ã‚¹ã‚¯ã‚­ãƒ¥ãƒ¼ã¸ã¨è¿½åŠ ã•ã‚Œã¦ã€ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯é–¢æ•°ã®å¼•æ•°ã¯ undefined ã¨ãªã‚‹

Promise Chainã•ã›ãŸã„å ´åˆã¯å¿…ãšã€Promiseã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’returnã™ã‚‹ã€‚(2)ã¨(3)ã®é•ã„ã‚’ã¿ã¦ã¿ã‚‹ã€‚
```js
//  promiseShouldBeReturned-non.js
console.log("ğŸ¦– [1] Sync");

const returnPromise = (resolvedValue, order) => {
  return new Promise((resolve) => {
    console.log(`ğŸ‘» ${order} (a)sync`);
    resolve(resolvedValue);
  });
};

returnPromise("1st Promise", "[2]")
  .then((value) => {
    console.log("ğŸ‘¦ [5] Async");
    console.log("ğŸ‘¦ Resolved value: ", value);
    // return ã—ãªã„å ´åˆã¯å‰¯ä½œç”¨ã¨ãªã‚Šå€¤ãŒæ¸¡ã‚‰ãªã„
    returnPromise("2nd Promise", "[6]");
    // ğŸ ã“ã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‹ã‚‰ã¯ Promise ãŒè¿”ã•ã‚Œã¦ã„ãªã„ã®ã§è¿½åŠ ã®ãƒã‚¤ã‚¯ãƒ­ã‚¿ã‚¹ã‚¯ãŒç™ºç”Ÿã—ãªã„
  })
  .then((value) => {
    // ã“ã® value ã¯ undefined ã¨ãªã‚‹
    console.log("ğŸ‘¦ [9] Async");
    console.log("ğŸ‘¦ Resolved value: ", value); // undefined ãŒè¡¨ç¤ºã•ã‚Œã‚‹
  });
returnPromise("3rd Promise", "[3]")
  .then((value) => {
    console.log("ğŸ‘¦ [7] Async");
    console.log("ğŸ‘¦ Resolved value: ", value);
    // Promise ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã«ã¤ã„ã¦ã¯å¿…ãš return ã™ã‚‹ã‚ˆã†ã«ã™ã‚‹
    return returnPromise("4th Promise", "[8]")
    // ğŸ”¥ ã“ã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‹ã‚‰ã¯ Promise ãŒè¿”ã•ã‚Œã‚‹ã®ã§è¿½åŠ ã®ãƒã‚¤ã‚¯ãƒ­ã‚¿ã‚¹ã‚¯ãŒï¼’ã¤ç™ºç”Ÿã™ã‚‹
  })
  .then((value) => {
    console.log("ğŸ‘¦ [10] Async");
    console.log("ğŸ‘¦ Resolved value: ", value); // å€¤ãŒç¹‹ãŒã‚‹ã®ã§ 4th Promise ã¨è¡¨ç¤ºã•ã‚Œã‚‹
  });

console.log("ğŸ¦– [4] Sync");
```
```shell
â¯ deno run promiseShouldBeReturned-non.js
ğŸ¦– [1] Sync
ğŸ‘» [2] (a)sync
ğŸ‘» [3] (a)sync
ğŸ¦– [4] Sync
ğŸ‘¦ [5] Async
ğŸ‘¦ Resolved value: 1st Promise
ğŸ‘» [6] (a)sync
ğŸ‘¦ [7] Async
ğŸ‘¦ Resolved value: 3rd Promise
ğŸ‘» [8] (a)sync
ğŸ‘¦ [9] Async
ğŸ‘¦ Resolved value: undefined
ğŸ‘¦ [10] Async
ğŸ‘¦ Resolved value: 4th Promise
```

{/* async/await */}