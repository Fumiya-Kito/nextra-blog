# git2

## 3. リリースブランチ作成方法
- GitFlowでは、developからブランチを切ってリリースブランチとし検証作業を進めmainにマージする
- 今回は、mainから切って、各案件featureブランチをリリースにスカッシュマージを行う方式にした
- → これにより顧客はmainから1コミットで成果物一覧を確認取得できる(もちろん履歴をきれいにする意味もある)
- 修正がなければ、PRにてFFマージ(リリースブランチ履歴=main履歴)すればよいし、修正があり複数コミット進んだ状態になれば、再度PRにてスカッシュマージしてもらう

### 手順
```sh
# @任意のブランチ
git switch main

# 最新の取得
git pull origin main

# リリースブランチ作成
git switch -c release/<案件名>

# featureブランチを統合していく(複数同時リリースなら繰り返す)
git merge --squash feature/<案件名>
# 競合があれば解消してステージング(git add)
git commit -m "<コミットメッセージ(リリース内容)>"
git push -u origin release/<案件名>
```
#### 競合解消について
```sh
# 普通にエディタなどで修正する方法の他にコマンドでどっちからブランチのファイル内容を採用する方法あり
git checkout --ours . #(すべてマージ先(今いるブランチ)のファイルに作業ツリーを変更)
git checkout --theirs . #(すべてマージ元のファイルに作業ツリーを変更)
git checkout --theirs <path/filename.js>
git checkout --theirs $'日本語パス/日本語ファイル名.xlsx'

# 解消後、statusを確認して順次コミット
git commit -m "message"
```


## 4. フェッチ・チェックアウトの定義再確認
### フェッチとは
- リモートリポジトリの最新の状態（ブランチの情報やコミット）をローカルに取得するコマンド
- ただし、ローカルリポジトリの作業ブランチ`main`ではなく、リモート追跡ブランチ`origin/main` or `remotes/origin/main`に反映させること
- ローカル(作業)ブランチ`main`とリモートブランチ`main`の紐付けは、初回プッシュ時`git push -u origin main`などに行われる
- このとき、`remotes/origin/main`という追跡ブランチが作成され、紐付け完了。`git push`や`git pull`と省略コマンドができるように。
- fetchは基本的に全ブランチ一括で同期を行う
- pullは一括フェッチ`git fetch` + マージ`git merge origin/main`

### チェックアウトとは
- 作業ツリーとステージの状態を特定のコミットに切り替えること
- ブランチのチェックアウトも可能だが、実態は各ブランチの最新コミットへ切り替えているだけ
- HEAD=「現在チェックアウトしているコミット」へのポインタを切り替えている
- ヘッドが切り替わると(チェックアウトすると)、そのコミットの状態をステージと作業ツリーへ反映・整備する
- もし、未コミットの変更がある場合は、チェックアウトによる整備が完了した後、未コミット差分を反映させる
- つまり、切り替えたコミットの状態よりもローカルで触っていた変更の方が強いので注意
- チェックアウトが失敗する原因の大半が切り替え先の状態と未コミットのローカルの状態が競合していること→`stash`を利用

```
        HEAD
          ↓
    [現在のコミット]---[前のコミット]----...---[initコミット] ←ブランチ
          ↓
┌────────────┐
│ ステージ    │ ← addされた内容（準備中）
└────────────┘
          ↓
┌────────────┐
│ 作業ツリー  │ ← 実際のファイル群
└────────────┘
```

## 5. 作業ツリーについて、操作コマンド
- 作業ツリーとは、「実際にファイルが存在していて、あなたが編集している場所のこと」

| 領域                  | 説明                            |
| ------------------- | ----------------------------- |
| 作業ツリー（Working Tree） | 実際のファイルシステム上にある現在のファイル群（編集対象） |
| ステージング領域（Index）     | コミット予定の差分を一時的に置いておく場所         |
| リポジトリ（HEAD が指すコミット） | すでに記録された過去の状態（`.git` に格納）     |

```sh
# 未コミットファイル最新コミットの状態に戻す (今の変更を消す・やりなおしたい)
git checkout .
git checkout <path/filename>

# 未コミットファイルを最新コミットの状態に戻したいけど、その状態も取っておきたい
git stash # 今いるのコミットメッセージでスタッシュされる git stash pushと同義
git stash push -m "作業内容のメモ"

# スタッシュリストを見る
git stash list

# スタッシュした変更を作業ツリーに反映させる(リストに残る)
git stash apply stash@{0}

# スタッシュを戻す popなので最後にスタッシュした状態をリストから削除して反映
git stash pop

# スタッシュを削除(整理しないと訳わからなくなる)
git stash drop stash@{0}
git stash clear # 一括


# 差分を見る
git stash show -p stash@{0}

```