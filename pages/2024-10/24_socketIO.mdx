# ゴキブリポーカーのWebAppを作成したい
### そもそもオンラインゲームのリアルタイム通信ってどうやるの?
- 結論: **ソケット通信** 
- supabaseを最近さわっていたため、リアルタイムDBとか?って思ったが←遅いのでアクションゲーム的なのは無理
- →基本的にはメモリ上でゲーム情報を保持して、全クライアントがサーバーとやりとりするのが基本
- イメージは`class Game`をインスタンス化して、１ゲーム１インスタンスで状態管理
- じゃあ、HTTP通信じゃいけないの?←これもDBほどではないにしても遅い
- 下の解説＋そもそも同期通信(`HTTP`)と非同期通信(`socket`)の違いででプレイヤーの入力をわざわざ待ってなんていたらリアルタイム性が損なわれる

[Socket.IOとは](https://qiita.com/taisei-ide-0123/items/1b605b1f0d6ec7feed22)
> マルチプレイヤーで、2人以上のユーザーが同時にプレイできるゲームを開発していると仮定します。
その場合、さまざまな理由でHTTPまたはHTTPS呼び出しを行うことはありません。
その理由のひとつは、パケットサイズが大きいことと、これらの呼び出しが非常に遅いことです。
このようなシナリオでは、ソケットなどのライブラリを使用して、サーバーとの間でデータを送受信します。
ソケットは非常に高速で、必要なデータパケットのみを送信できます。
HTTPプログラミングを使用すると、サーバーとリアルタイムでやり取りするマルチプレイヤーゲームやアプリを作成することはできません。ん

### 技術スタックとか色々考えてみた
- 前提としてclinet/serverでアプリを分けるのが基本
- →フロント:`nextjs`, バック: `hono`の`websocket`←`socket.io`がかなり有名っぽいが、Expressのライブラリなので普通には実装できなさそう
- 無料で使えるサーバーレス系のホスティング先は1ファンクションでその機能を終えるため、長時間接続を要求するソケット通信と相性悪く、だいたい対応していない
- →EC2とかフルで機能使う系クラウドサービスのが一般的っぽい
- 料金抑えるとなると`Render`がWebsocketに対応しているらしい
- `hono (websocket)`をRenderにデプロイ, NextJSを`Vercel`にデプロイがいい感じかな

### と思ったら...結局SupabaseリアルタイムDBで良い気がする
```txt filename="User"
ゲームの状態を毎回DBに保管するのはコストが高すぎるように思えるが、ターン制のゲームとかならありえるのか？
```

```txt filename="ChatGPT"
ターン制のゲームであれば、毎回の状態をデータベースに保存するのは現実的です。理由として、ターン制ゲームではリアルタイム性がそれほど重要でないため、ゲーム状態の更新頻度が低く、データベースへの書き込みコストも抑えられるからです。
ターン制ゲームでのデータベース使用が現実的な理由
更新頻度が低い: アクションゲームのように秒単位で状態が変わるわけではなく、1ターンごとにしかデータの更新が発生しないため、頻繁な書き込みがない。
安全な状態管理: ゲームの進行状況やターンごとの状態をデータベースに保存することで、サーバー障害時やリロード時に進行中のゲーム状態を復元できるという利点があります。これは、特にオンライン対戦ゲームなどで重要です。
データ量が小さい: 各ターンごとの状態データは比較的軽量です。プレイヤーのターン、ボードの状態、スコアなど、少量のデータを扱うため、データベースへの保存コストも軽減されます。
使い方のシナリオ
ボードゲームやカードゲーム: チェスや将棋、ポーカーなどのようなターン制ゲームでは、各ターンごとのゲーム状態を保存してもパフォーマンスへの影響が少ない。
ターンごとのバックアップ: 各ターン終了時にその状態を保存することで、復元可能なゲームセッションを作成することができます。
コストに関する注意点
大量のリアルタイム更新が必要なゲームでは、データベースに頻繁に書き込むのはコストがかかるため、WebSocketなどでクライアント間のリアルタイム通信を管理し、最終結果のみデータベースに保存するのが効率的です。
まとめ
ターン制のゲームでは、各ターンごとにゲーム状態をデータベースに保存するのは現実的なアプローチです。特にセッションの信頼性や復元性を高めるために、こうしたデータの保存は有効です。ただし、リアルタイム通信が重要なゲームではWebSocketのような技術を併用することも検討するべきです。
```

```txt filename="実際にDBにガンガン書き込んでいく系ゲームの例"
1. チェス.com
概要: 世界中のプレイヤーと対戦できるオンラインチェスプラットフォームです。
特徴:
プレイヤーは交互にターンを進め、ゲームの状態はリアルタイムでサーバーに保存されます。
ゲームが終了すると、全ての手がデータベースに保存され、後から再生したり分析したりできます。
2. Hearthstone
概要: Blizzard Entertainmentが開発したデジタルカードゲームです。
特徴:
プレイヤーは交互にカードをプレイし、ターンごとにゲーム状態がデータベースに保存されます。
リアルタイムの対戦が行われ、勝敗やカードの使用履歴がサーバーに記録されます。
3. Civilization VI
概要: プレイヤーが文明を築き、他のプレイヤーやAIと対戦するターン制ストラテジーゲームです。
特徴:
プレイヤーの行動やゲームの進行状況がサーバーに保存され、オンラインマルチプレイでのセッションを支援します。
4. League of Legends（LoL）
概要: チーム対抗のMOBA（Multiplayer Online Battle Arena）ゲーム。
特徴:
各試合の進行状況やプレイヤーの統計データがリアルタイムでデータベースに保存され、試合終了後に詳細な分析が可能です。
5. Tabletop Simulator
概要: 様々なボードゲームやカードゲームをシミュレートできるプラットフォーム。
特徴:
プレイヤーのターンがリアルタイムで保存され、ゲームの状態や進行がオンラインで共有されます。
6. Twitch Plays Pokémon
概要: Twitchプラットフォーム上で実施された、視聴者がチャットでコントロールするポケモンプレイ企画。
特徴:
プレイヤーの入力がリアルタイムでデータベースに保存され、ゲーム状態が変更されていきます。視聴者が投票し、次の行動を決定します。
まとめ
これらのゲームやサービスは、ターン制ゲームにおいてデータベースを効果的に使用しており、ゲームの進行状況を記録し、プレイヤーにリアルタイムで情報を提供しています。データベースを利用することで、ゲームの信頼性やプレイヤーエクスペリエンスが向上しています。
```

- ということで`NextJS`×`Supabase`でいい気がする。

### で、本当に遅延大丈夫か？
```txt filename="User"
1s以上送れると流石にターン制ゲームでもUIUXが相当落ちると思うが
NextJSとSupabase（無料枠）でクライアントは４Gのセルラー通信を仮定すると、どれくらいの遅延になるか？１s以上の遅延が頻発するか？
```

```txt filename="GPT"
> Next.jsとSupabaseを使ったターン制ゲームのクライアントで、4Gセルラー通信を仮定した場合の遅延について考えます。以下の要因が影響します。
遅延の要因
ネットワークの遅延:

4Gセルラー通信の平均的な遅延は、通常20msから100ms程度ですが、条件によってはそれ以上になることもあります。
ネットワークの混雑、信号の強さ、ユーザーの位置（都市部 vs. 郊外）などが影響します。
サーバーの応答時間:

Supabaseのようなクラウドサービスを使用する場合、サーバーの応答時間も考慮する必要があります。
Supabaseは通常、数十ミリ秒の応答時間が期待できますが、サーバーの負荷や地域によっては変動します。
データベースの処理時間:

データの読み書きが含まれるため、データベースへのクエリや更新の処理に要する時間も考慮が必要です。
簡単なクエリの場合は数ミリ秒から数十ミリ秒ですが、複雑なクエリや高負荷な状態では遅延が増える可能性があります。
UIの描画時間:

クライアント側でのUI描画にかかる時間も遅延の一部です。一般的に、適切に最適化されていれば、数十ミリ秒程度で済むことが多いですが、複雑なUIや多くの更新がある場合は時間がかかることがあります。
遅延の合計例
以下は、各要因を考慮した場合の遅延の概算です：

ネットワーク遅延: 50ms (平均値)
サーバー応答時間: 30ms
データベース処理時間: 20ms
UI描画時間: 20ms
合計遅延: 50 + 30 + 20 + 20 = 120ms

1秒以上の遅延の頻発可能性
1秒以上の遅延が頻発する可能性は、次の条件によります：

ネットワークの不安定さ: 信号が弱い場所や多くのユーザーが同じ回線を使用している場合、遅延が大きくなる可能性があります。特に混雑した場所では、1秒を超えることもあります。

サーバーの負荷: Supabaseの無料枠にはリソースの制限があるため、アクセスが集中する時間帯にサーバーの応答時間が遅くなる可能性があります。

データベースのサイズや複雑さ: 大量のデータや複雑なクエリの場合、応答時間が増えることがあります。

まとめ
通常の条件下では、合計遅延は100ms〜300ms程度になることが予想され、1秒以上の遅延が頻発することは少ないです。
ただし、特に不安定なネットワーク環境や高負荷のサーバーが影響を及ぼす場合には、1秒以上の遅延が発生することもあり得ます。ターン制ゲームにおいては、ユーザー体験に影響を与える可能性があるため、リアルタイムのフィードバックを考慮した設計が重要です。
```